--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

--// SETTINGS
local MAX_WALK_SPEED = 16
local MAX_ALLOWED_MULTIPLIER = 3         -- tolerans katsayısı
local TELEPORT_DISTANCE_THRESHOLD = 80   -- direkt ışınlanma mesafesi
local FLAG_LIMIT = 5                     -- kaç ihlal sonrası kick

--// PLAYER DATA
local PlayerData = {}

----------------------------------------------------
-- INIT PLAYER
----------------------------------------------------

local function SetupPlayer(player)
	PlayerData[player] = {
		LastPosition = nil,
		LastTime = tick(),
		Flags = 0
	}
end

local function CleanupPlayer(player)
	PlayerData[player] = nil
end

Players.PlayerAdded:Connect(SetupPlayer)
Players.PlayerRemoving:Connect(CleanupPlayer)

----------------------------------------------------
-- CORE CHECK LOOP (SERVER SIDE)
----------------------------------------------------

RunService.Heartbeat:Connect(function()
	for _, player in ipairs(Players:GetPlayers()) do
		
		local character = player.Character
		if not character then continue end
		
		local humanoid = character:FindFirstChildOfClass("Humanoid")
		local root = character:FindFirstChild("HumanoidRootPart")
		if not humanoid or not root then continue end
		
		local data = PlayerData[player]
		if not data then continue end
		
		local currentTime = tick()
		local deltaTime = currentTime - data.LastTime
		
		if not data.LastPosition then
			data.LastPosition = root.Position
			data.LastTime = currentTime
			continue
		end
		
		local distance = (root.Position - data.LastPosition).Magnitude
		local speed = distance / math.max(deltaTime, 0.016)
		
		----------------------------------------------------
		-- TELEPORT DETECTION
		----------------------------------------------------
		
		local maxAllowedSpeed = MAX_WALK_SPEED * MAX_ALLOWED_MULTIPLIER
		
		local isFreefall = humanoid:GetState() == Enum.HumanoidStateType.Freefall
		local isFlying = humanoid:GetState() == Enum.HumanoidStateType.Flying
		
		local suspicious = false
		
		-- Aşırı hız
		if speed > maxAllowedSpeed and not isFreefall and not isFlying then
			suspicious = true
		end
		
		-- Direkt mesafe zıplaması
		if distance > TELEPORT_DISTANCE_THRESHOLD then
			suspicious = true
		end
		
		if suspicious then
			
			data.Flags += 1
			
			-- Pozisyonu geri sar
			root.CFrame = CFrame.new(data.LastPosition)
			
			warn("[ANTI TELEPORT] Flag:", player.Name, "Count:", data.Flags)
			
			if data.Flags >= FLAG_LIMIT then
				player:Kick("Teleport exploit detected.")
			end
		else
			-- Reset flag yavaşça
			if data.Flags > 0 then
				data.Flags -= 1
			end
		end
		
		data.LastPosition = root.Position
		data.LastTime = currentTime
	end
end)